<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üé§ N'oubliez pas les Paroles</title>
<link href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-dark: #0a0a1a;
    --bg-card: #12122a;
    --accent: #f7b731;
    --accent-glow: #f7b73166;
    --pink: #e84393;
    --pink-glow: #e8439366;
    --blue: #00cec9;
    --blue-glow: #00cec966;
    --text: #f0f0f0;
    --text-dim: #8888aa;
    --success: #00b894;
    --danger: #d63031;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg-dark);
    color: var(--text);
    font-family: 'Nunito', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: 
      radial-gradient(ellipse at 20% 50%, #1a0a3a 0%, transparent 50%),
      radial-gradient(ellipse at 80% 20%, #0a1a3a 0%, transparent 50%),
      radial-gradient(ellipse at 50% 80%, #1a0a2a 0%, transparent 50%);
    z-index: -1;
  }

  .app {
    max-width: 100%;
    margin: 0 auto;
    padding: 10px 20px;
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* ---- Top Bar ---- */
  .top-bar-app {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 0;
    flex-shrink: 0;
  }

  .top-bar-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .top-bar-center {
    text-align: center;
    flex: 1;
  }

  .top-bar-right {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .topbar-btn {
    background: rgba(255,255,255,0.06);
    border: 1px solid #333;
    border-radius: 8px;
    padding: 6px 12px;
    color: var(--text-dim);
    font-size: 0.72rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .topbar-btn:hover { background: rgba(255,255,255,0.1); color: var(--text); }
  .topbar-btn.accent {
    background: linear-gradient(135deg, var(--accent), #e0a020);
    color: #1a1a1a;
    border-color: transparent;
    font-weight: 800;
  }

  /* ---- Desktop layout: video+controls+guess ---- */
  .main-stage {
    display: flex;
    gap: 14px;
    align-items: stretch;
    flex: 1;
    min-height: 0;
  }

  .stage-left {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
  }

  .stage-right {
    width: 320px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  @media (max-width: 1000px) {
    .app { height: auto; overflow: auto; }
    .main-stage { flex-direction: column; }
    .stage-right { width: 100%; }
    .video-row { flex-direction: column; }
    .video-controls-side { flex-direction: row; justify-content: center; width: 100%; }
  }

  /* Video + side controls row */
  .video-row {
    display: flex;
    gap: 10px;
    align-items: stretch;
    flex: 1;
    min-height: 0;
  }

  .video-controls-side {
    display: flex;
    flex-direction: column;
    gap: 6px;
    justify-content: center;
    flex-shrink: 0;
  }

  .video-controls-side .btn {
    padding: 10px 14px;
    font-size: 0.8rem;
    white-space: nowrap;
  }

  /* ---- Library Drawer ---- */
  .drawer-toggle {
    /* Now in the topbar, no fixed positioning */
  }

  .library-drawer {
    position: fixed;
    left: -440px;
    top: 0; bottom: 0;
    width: 420px;
    max-width: calc(100vw - 20px);
    background: var(--bg-card);
    border-right: 1px solid #222244;
    z-index: 899;
    display: flex;
    flex-direction: column;
    transition: left 0.3s ease;
    box-shadow: 4px 0 24px rgba(0,0,0,0.5);
  }
  .drawer-open .library-drawer { left: 0; }

  /* Backdrop */
  .drawer-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 898;
    display: none;
  }
  .drawer-open .drawer-backdrop { display: block; }

  .library-drawer .drawer-header {
    padding: 16px 20px;
    border-bottom: 1px solid #222244;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
  }

  .library-drawer .drawer-header h3 {
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--text-dim);
  }

  .library-drawer .drawer-body {
    flex: 1;
    overflow-y: auto;
    padding: 12px 20px;
  }

  .library-drawer .drawer-footer {
    padding: 10px 20px;
    border-top: 1px solid #222244;
    flex-shrink: 0;
  }

  .drawer-close-btn {
    background: none;
    border: none;
    color: var(--text-dim);
    font-size: 1.2rem;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
  }
  .drawer-close-btn:hover { color: var(--text); background: rgba(255,255,255,0.1); }

  /* Pagination */
  .pagination {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 10px;
    font-size: 0.78rem;
  }
  .pagination button {
    background: #2a2a4a;
    border: 1px solid #333;
    color: var(--text);
    border-radius: 6px;
    padding: 4px 10px;
    font-size: 0.75rem;
    cursor: pointer;
  }
  .pagination button:disabled { opacity: 0.3; cursor: default; }
  .pagination button:hover:not(:disabled) { background: #3a3a5a; }
  .pagination .page-info { color: var(--text-dim); }
  .pagination select {
    background: #2a2a4a;
    border: 1px solid #333;
    color: var(--text);
    border-radius: 6px;
    padding: 2px 6px;
    font-size: 0.75rem;
  }

  /* ---- Header ---- */
  .header {
    text-align: center;
    padding: 0;
    flex-shrink: 0;
  }

  .header h1 {
    font-family: 'Dela Gothic One', cursive;
    font-size: 1.2rem;
    background: linear-gradient(135deg, var(--accent), var(--pink));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    filter: drop-shadow(0 0 20px var(--accent-glow));
  }

  .header p {
    color: var(--text-dim);
    margin-top: 0;
    font-size: 0.72rem;
    display: none; /* hide subtitle to save space */
  }

  /* ---- Video Stage ---- */
  .video-stage {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    background: #000;
    flex: 1;
    min-height: 200px;
    margin: 0;
    border: 2px solid #222244;
    box-shadow: 0 0 20px rgba(0,0,0,0.4), 0 0 40px var(--accent-glow);
  }

  .video-stage video {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }

  .video-stage .placeholder {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    background: linear-gradient(135deg, #0a0a2a, #1a0a3a);
  }

  .placeholder .icon { font-size: 4rem; opacity: 0.3; }
  .placeholder .msg { color: var(--text-dim); font-size: 0.95rem; }

  /* Subtitle overlay */
  .subtitle-overlay {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    padding: 20px 30px 24px;
    background: linear-gradient(transparent, rgba(0,0,0,0.88));
    text-align: center;
    min-height: 80px;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    pointer-events: none;
  }

  .subtitle-text {
    font-size: var(--sub-font-size, 1.5rem);
    font-weight: 800;
    line-height: 1.6;
    text-shadow: 0 2px 8px rgba(0,0,0,0.9);
    color: var(--sub-color-base, #f0f0f0);
    background: var(--sub-bg, transparent);
    padding: 4px 12px;
    border-radius: 8px;
  }

  .subtitle-text .word {
    display: inline-block;
    margin: 0 3px;
    padding: 2px 4px;
    border-radius: 4px;
    transition: all 0.25s;
    color: var(--sub-color-base, #f0f0f0);
  }

  .word.highlighted { color: var(--sub-color-highlight, var(--accent)); transform: scale(1.08); }

  .word.hidden-word {
    background: rgba(255,255,255,0.13);
    color: transparent;
    border-radius: 6px;
    min-width: 50px;
    position: relative;
  }
  .word.hidden-word::after {
    content: '____';
    color: var(--text-dim);
    position: absolute;
    left: 50%; top: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.9rem;
    letter-spacing: 2px;
  }

  .word.revealed {
    background: var(--sub-bg-revealed, rgba(0, 184, 148, 0.3));
    color: var(--sub-color-revealed, var(--success));
    animation: revealPop 0.4s ease;
  }

  .word.revealed-static {
    background: var(--sub-bg-revealed, rgba(0, 184, 148, 0.25));
    color: var(--sub-color-revealed, var(--success));
  }

  .word.backing-vocal {
    color: var(--sub-color-backing, var(--text-dim));
    opacity: var(--sub-alpha-backing, 0.6);
    font-style: italic;
  }

  /* ---- Sound mode option ---- */
  .sound-mode-option {
    padding: 6px 12px;
    text-align: center;
  }

  .sound-mode-label {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 0.82rem;
    color: var(--text-dim);
    user-select: none;
    transition: color 0.2s;
  }
  .sound-mode-label:hover { color: var(--text); }

  .sound-mode-label input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: var(--accent);
    cursor: pointer;
  }

  @keyframes revealPop {
    0% { transform: scale(1.4); }
    50% { transform: scale(0.9); }
    100% { transform: scale(1); }
  }

  /* Status badges */
  .status-bar {
    position: absolute;
    top: 14px; right: 14px;
    display: flex; gap: 8px;
  }

  .status-pill {
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    backdrop-filter: blur(10px);
  }

  .status-pill.playing { background: rgba(247,183,49,0.25); color: var(--accent); border: 1px solid var(--accent); }
  .status-pill.muted { background: rgba(214,48,49,0.25); color: var(--danger); border: 1px solid var(--danger); animation: pulse 1s infinite; }
  .status-pill.paused { background: rgba(136,136,170,0.25); color: var(--text-dim); border: 1px solid #555; }

  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }

  /* Score */
  .score-display {
    position: absolute;
    top: 14px; left: 14px;
    backdrop-filter: blur(10px);
    background: rgba(0,0,0,0.5);
    padding: 6px 14px;
    border-radius: 12px;
    border: 1px solid #333;
  }
  .score-display .label { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 2px; color: var(--text-dim); }
  .score-display .value { font-family: 'Dela Gothic One', cursive; font-size: 1.4rem; color: var(--accent); }

  /* ---- Progress ---- */
  .progress-container {
    background: #1a1a3a;
    border-radius: 8px;
    height: 6px;
    margin: 8px 0;
    overflow: visible;
    position: relative;
    cursor: pointer;
  }

  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--pink));
    border-radius: 8px;
    transition: width 0.15s linear;
  }

  .cutoff-marker {
    position: absolute;
    top: -5px;
    width: 3px;
    height: 16px;
    background: var(--danger);
    border-radius: 2px;
    box-shadow: 0 0 8px var(--danger);
    z-index: 2;
  }

  .time-display {
    display: flex;
    justify-content: space-between;
    font-size: 0.78rem;
    color: var(--text-dim);
    margin-bottom: 12px;
    font-variant-numeric: tabular-nums;
  }

  /* ---- Controls ---- */
  .controls {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
    margin: 12px 0;
  }

  .btn {
    padding: 11px 24px;
    border: none;
    border-radius: 12px;
    font-family: 'Nunito', sans-serif;
    font-weight: 700;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 7px;
  }
  .btn:hover { transform: translateY(-2px); }
  .btn:active { transform: translateY(0); }
  .btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none; }

  .btn-primary { background: linear-gradient(135deg, var(--accent), #e0a020); color: #1a1a1a; box-shadow: 0 4px 12px var(--accent-glow); }
  .btn-secondary { background: var(--bg-card); color: var(--text); border: 1px solid #333; }
  .btn-danger { background: linear-gradient(135deg, var(--pink), #c0392b); color: white; box-shadow: 0 4px 12px var(--pink-glow); }
  .btn-success { background: linear-gradient(135deg, var(--blue), var(--success)); color: #1a1a1a; box-shadow: 0 4px 12px var(--blue-glow); }
  .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); color: #1a1a1a; box-shadow: 0 4px 12px rgba(243,156,18,0.3); }

  /* ---- Guess Area ---- */
  .guess-area {
    background: var(--bg-card);
    border-radius: 12px;
    padding: 14px;
    border: 1px solid #222244;
    display: none;
  }
  .guess-area.visible { display: block; }
  .guess-area.active { display: block; }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .guess-area h3 {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--text-dim);
    margin-bottom: 10px;
  }

  .guess-input-row { display: flex; gap: 10px; }

  .guess-input {
    flex: 1;
    padding: 12px 16px;
    background: rgba(255,255,255,0.05);
    border: 2px solid #333;
    border-radius: 12px;
    color: var(--text);
    font-family: 'Nunito', sans-serif;
    font-size: 1rem;
    font-weight: 600;
    outline: none;
    transition: border-color 0.2s;
  }
  .guess-input:focus { border-color: var(--accent); }
  .guess-input::placeholder { color: var(--text-dim); }

  .guess-feedback {
    margin-top: 8px;
    font-size: 0.85rem;
    min-height: 1.2em;
  }

  /* ---- Song Library ---- */
  .library {
    background: var(--bg-card);
    border-radius: 16px;
    padding: 20px;
    margin: 20px 0;
    border: 1px solid #222244;
  }

  .library-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 14px;
  }

  .library-header h3 {
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--text-dim);
  }

  .library-actions {
    display: flex;
    gap: 8px;
  }

  .btn-sm {
    padding: 6px 14px;
    border: none;
    border-radius: 8px;
    font-family: 'Nunito', sans-serif;
    font-weight: 700;
    font-size: 0.78rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-sm:hover { transform: translateY(-1px); }

  .btn-sm.random { background: linear-gradient(135deg, var(--pink), #a020f0); color: white; }
  .btn-sm.refresh { background: rgba(255,255,255,0.08); color: var(--text-dim); border: 1px solid #333; }

  .song-count {
    font-size: 0.8rem;
    color: var(--text-dim);
    margin-bottom: 12px;
  }

  /* Search */
  .search-box {
    width: 100%;
    padding: 10px 16px;
    background: rgba(255,255,255,0.04);
    border: 1px solid #2a2a4a;
    border-radius: 10px;
    color: var(--text);
    font-family: 'Nunito', sans-serif;
    font-size: 0.9rem;
    outline: none;
    margin-bottom: 12px;
    transition: border-color 0.2s;
  }
  .search-box:focus { border-color: var(--accent); }
  .search-box::placeholder { color: #555; }

  /* Song list */
  .song-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
    max-height: 85%;
    overflow-y: auto;
    padding-right: 4px;
  }

  .song-list::-webkit-scrollbar { width: 6px; }
  .song-list::-webkit-scrollbar-track { background: transparent; }
  .song-list::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

  .song-item {
    padding: 12px 16px;
    background: rgba(255,255,255,0.02);
    border: 1px solid #2a2a4a;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .song-item:hover { background: rgba(247,183,49,0.06); border-color: var(--accent); }
  .song-item.active { background: rgba(247,183,49,0.1); border-color: var(--accent); box-shadow: 0 0 16px var(--accent-glow); }

  .song-info .title { font-weight: 700; font-size: 0.95rem; }
  .song-info .artist { color: var(--text-dim); font-size: 0.82rem; margin-top: 1px; }
  .song-info .meta { color: #555; font-size: 0.72rem; margin-top: 3px; }

  .song-right { display: flex; align-items: center; gap: 10px; }

  .difficulty {
    font-size: 0.68rem;
    padding: 3px 10px;
    border-radius: 8px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .difficulty.easy { background: rgba(0,184,148,0.15); color: var(--success); }
  .difficulty.medium { background: rgba(247,183,49,0.15); color: var(--accent); }
  .difficulty.hard { background: rgba(214,48,49,0.15); color: var(--danger); }

  .tag-badge {
    display: inline-block;
    background: rgba(108, 92, 231, 0.15);
    color: #a29bfe;
    padding: 1px 8px;
    border-radius: 10px;
    font-size: 0.65rem;
    font-weight: 600;
    margin-right: 4px;
  }
  .tags-row { margin-top: 3px; }

  .btn-sm.party {
    background: linear-gradient(135deg, #6c5ce7, #a29bfe);
    color: white;
  }

  /* ---- Party Modal ---- */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(6px);
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.hidden { display: none; }

  .modal-box {
    background: var(--bg-card);
    border: 1px solid #222244;
    border-radius: 20px;
    padding: 30px;
    max-width: 480px;
    width: 92%;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-box h2 {
    font-family: 'Dela Gothic One', cursive;
    font-size: 1.3rem;
    background: linear-gradient(135deg, #6c5ce7, var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 16px;
    text-align: center;
  }

  .modal-field { margin-bottom: 14px; }
  .modal-field label {
    display: block;
    font-size: 0.78rem;
    color: var(--text-dim);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 6px;
  }

  .modal-field input[type="number"] {
    width: 100%;
    padding: 10px 14px;
    border: 2px solid #333;
    border-radius: 10px;
    background: #1a1a2e;
    color: var(--text);
    font-size: 1.1rem;
    font-weight: 700;
    text-align: center;
    outline: none;
  }
  .modal-field input[type="number"]:focus { border-color: var(--accent); }

  .filter-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .filter-chip {
    padding: 5px 12px;
    border-radius: 16px;
    border: 1px solid #333;
    background: #1a1a2e;
    color: var(--text-dim);
    font-size: 0.78rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
  }
  .filter-chip:hover { border-color: #555; color: var(--text); }
  .filter-chip.include {
    background: rgba(0, 184, 148, 0.2);
    border-color: var(--success);
    color: var(--success);
  }
  .filter-chip.include::before { content: '‚úì '; }
  .filter-chip.exclude {
    background: rgba(214, 48, 49, 0.2);
    border-color: var(--danger);
    color: var(--danger);
    text-decoration: line-through;
  }
  .filter-chip.exclude::before { content: '‚úï '; }

  .modal-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }
  .modal-actions .btn { flex: 1; }

  .modal-match-count {
    text-align: center;
    font-size: 0.82rem;
    color: var(--text-dim);
    margin-top: 10px;
  }
  .modal-match-count strong { color: var(--accent); }

  /* ---- Settings rows (subtitle modal) ---- */
  .setting-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 10px;
  }
  .setting-row label {
    font-size: 0.82rem;
    font-weight: 700;
    color: var(--text-dim);
    min-width: 140px;
  }
  .setting-row input[type="color"] {
    width: 36px;
    height: 30px;
    border: 2px solid #333;
    border-radius: 8px;
    background: #1a1a2e;
    cursor: pointer;
    padding: 2px;
  }
  .setting-row input[type="range"] {
    flex: 1;
    max-width: 120px;
    accent-color: var(--accent);
  }
  .setting-row .range-value {
    font-size: 0.75rem;
    color: var(--text-dim);
    min-width: 36px;
    text-align: right;
  }
  .subtitle-preview {
    background: #111;
    border-radius: 12px;
    padding: 20px 16px;
    margin-top: 14px;
    text-align: center;
    min-height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .subtitle-preview .preview-text {
    font-size: 1.2rem;
    font-weight: 800;
    line-height: 1.6;
  }
  .subtitle-preview .preview-text .word {
    display: inline-block;
    margin: 0 3px;
    padding: 2px 4px;
    border-radius: 4px;
  }

  /* ---- Party HUD ---- */
  .party-hud {
    background: linear-gradient(135deg, rgba(108,92,231,0.15), rgba(162,155,254,0.08));
    border: 1px solid rgba(108,92,231,0.3);
    border-radius: 12px;
    padding: 10px 16px;
    margin-bottom: 10px;
    display: none;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }
  .party-hud.active { display: flex; }
  .party-hud .party-info {
    font-size: 0.82rem;
    font-weight: 700;
    color: #a29bfe;
  }
  .party-hud .party-score {
    font-family: 'Dela Gothic One', cursive;
    font-size: 1.1rem;
    color: var(--accent);
  }
  .party-hud .btn-sm {
    font-size: 0.72rem;
    padding: 4px 10px;
  }

  /* ---- Countdown overlay ---- */
  .countdown-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.85);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 50;
    pointer-events: none;
  }
  .countdown-overlay.hidden { display: none; }
  .countdown-number {
    font-family: 'Dela Gothic One', cursive;
    font-size: 5rem;
    color: var(--accent);
    animation: countPulse 1s ease infinite;
  }
  .countdown-label {
    font-size: 1rem;
    color: var(--text-dim);
    margin-top: 8px;
  }
  @keyframes countPulse {
    0%,100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.7; }
  }

  /* ---- Party Results Modal ---- */
  .party-results-list {
    max-height: 300px;
    overflow-y: auto;
  }
  .party-result-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #222;
  }
  .party-result-row .song-name {
    font-weight: 700;
    font-size: 0.85rem;
  }
  .party-result-row .song-artist-sm {
    font-size: 0.72rem;
    color: var(--text-dim);
  }
  .party-result-row .result-score {
    font-family: 'Dela Gothic One', cursive;
    font-size: 1rem;
    color: var(--accent);
  }
  .party-total-score {
    text-align: center;
    margin-top: 16px;
    padding-top: 12px;
    border-top: 2px solid #333;
  }
  .party-total-score .label { font-size: 0.8rem; color: var(--text-dim); }
  .party-total-score .big-score {
    font-family: 'Dela Gothic One', cursive;
    font-size: 2.2rem;
    color: var(--accent);
  }

  .no-video-badge {
    font-size: 0.65rem;
    padding: 2px 8px;
    border-radius: 6px;
    background: rgba(136,136,170,0.15);
    color: var(--text-dim);
  }

  /* ---- Empty state ---- */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-dim);
  }
  .empty-state .icon { font-size: 3rem; margin-bottom: 12px; opacity: 0.5; }
  .empty-state h3 { color: var(--text); margin-bottom: 8px; }
  .empty-state p { font-size: 0.88rem; line-height: 1.6; max-width: 500px; margin: 0 auto; }
  .empty-state code {
    display: block;
    background: rgba(255,255,255,0.05);
    padding: 14px;
    border-radius: 10px;
    margin: 14px auto;
    text-align: left;
    max-width: 420px;
    font-size: 0.82rem;
    line-height: 1.7;
    color: var(--accent);
  }

  /* ---- Info Panel (in modals now) ---- */
  .info-panel {
    background: var(--bg-card);
    border-radius: 16px;
    padding: 20px;
    margin: 20px 0;
    border: 1px solid #222244;
  }
  .info-panel h3 {
    font-family: 'Dela Gothic One', cursive;
    font-size: 0.95rem;
    color: var(--accent);
    margin-bottom: 10px;
  }
  .info-panel p {
    color: var(--text-dim);
    font-size: 0.88rem;
    line-height: 1.6;
    margin-bottom: 6px;
  }
  .info-panel kbd {
    background: rgba(255,255,255,0.08);
    padding: 2px 7px;
    border-radius: 5px;
    font-size: 0.78rem;
    border: 1px solid #444;
    font-family: 'Nunito', sans-serif;
  }

  /* ---- Loading overlay ---- */
  .loading-overlay {
    position: fixed; inset: 0;
    background: rgba(10,10,26,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    flex-direction: column;
    gap: 16px;
    transition: opacity 0.3s;
  }
  .loading-overlay.hidden { opacity: 0; pointer-events: none; }
  .spinner {
    width: 40px; height: 40px;
    border: 4px solid #333;
    border-top: 4px solid var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ---- Room Selection Screen ---- */
  .room-screen {
    position: fixed;
    inset: 0;
    background: var(--bg-dark);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .room-screen.hidden { display: none; }

  .room-box {
    background: var(--bg-card);
    border: 1px solid #222244;
    border-radius: 20px;
    padding: 40px;
    max-width: 460px;
    width: 90%;
    text-align: center;
  }

  .room-box h1 {
    font-family: 'Dela Gothic One', cursive;
    font-size: 1.6rem;
    background: linear-gradient(135deg, var(--accent), var(--pink));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 8px;
  }

  .room-box .subtitle { color: var(--text-dim); font-size: 0.9rem; margin-bottom: 28px; }

  .room-input-group {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
  }

  .room-input {
    flex: 1;
    padding: 12px 16px;
    border-radius: 12px;
    border: 2px solid #333;
    background: #1a1a2e;
    color: var(--text);
    font-size: 1rem;
    font-weight: 700;
    text-align: center;
    letter-spacing: 1px;
    outline: none;
    transition: border-color 0.3s;
  }
  .room-input:focus { border-color: var(--accent); }
  .room-input::placeholder { color: var(--text-dim); font-weight: 400; letter-spacing: 0; }

  .room-btn {
    padding: 12px 24px;
    border-radius: 12px;
    border: none;
    font-weight: 700;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .room-btn.primary {
    background: linear-gradient(135deg, var(--accent), #e6a020);
    color: #000;
  }
  .room-btn.primary:hover { transform: scale(1.05); }
  .room-btn.secondary {
    background: #2a2a4a;
    color: var(--text);
    width: 100%;
    margin-top: 8px;
  }
  .room-btn.secondary:hover { background: #3a3a5a; }

  .room-or {
    color: var(--text-dim);
    font-size: 0.8rem;
    margin: 16px 0;
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  .room-error {
    color: var(--danger);
    font-size: 0.8rem;
    margin-top: 8px;
    min-height: 20px;
  }

  .room-badge {
    display: inline-block;
    background: #2a2a4a;
    border: 1px solid #333;
    border-radius: 10px;
    padding: 6px 14px;
    font-size: 0.8rem;
    color: var(--accent);
    font-weight: 700;
    letter-spacing: 1px;
    margin: 8px 0;
    cursor: pointer;
  }
  .room-badge:hover { background: #3a3a5a; }

  /* ---- Responsive ---- */
  @media (max-width: 600px) {
    .header h1 { font-size: 1.3rem; }
    .subtitle-text { font-size: 1.1rem; }
    .controls { gap: 6px; }
    .btn { padding: 9px 16px; font-size: 0.82rem; }
  }

  /* ---- Volume Control ---- */
  .volume-control {
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--bg-card);
    border-radius: 12px;
    padding: 10px 16px;
    border: 1px solid #222244;
    margin: 10px 0;
  }

  .volume-control .vol-icon {
    font-size: 1.1rem;
    cursor: pointer;
    user-select: none;
    min-width: 28px;
    text-align: center;
  }

  .volume-slider {
    flex: 1;
    -webkit-appearance: none;
    appearance: none;
    height: 6px;
    border-radius: 3px;
    background: #2a2a4a;
    outline: none;
    cursor: pointer;
  }

  .volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    box-shadow: 0 0 8px var(--accent-glow);
    transition: transform 0.15s;
  }

  .volume-slider::-webkit-slider-thumb:hover {
    transform: scale(1.2);
  }

  .volume-slider::-moz-range-thumb {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: none;
    box-shadow: 0 0 8px var(--accent-glow);
  }

  .volume-pct {
    font-size: 0.78rem;
    color: var(--text-dim);
    min-width: 36px;
    text-align: right;
    font-variant-numeric: tabular-nums;
  }

  /* ---- Cutoff window markers on progress bar ---- */
  .cutoff-window-marker {
    position: absolute;
    top: -2px;
    height: 10px;
    background: rgba(214, 48, 49, 0.35);
    border-left: 2px solid var(--danger);
    border-right: 2px solid var(--danger);
    border-radius: 3px;
    z-index: 2;
    box-shadow: 0 0 6px rgba(214, 48, 49, 0.3);
    pointer-events: none;
  }

  /* ---- Window progress indicator ---- */
  .window-progress {
    background: var(--bg-card);
    border-radius: 12px;
    padding: 12px 16px;
    margin: 10px 0;
    border: 1px solid #222244;
    display: none;
  }

  .window-progress.active { display: block; animation: slideUp 0.3s ease; }

  .window-progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  .window-progress-header .wp-label {
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
  }

  .window-progress-header .wp-count {
    font-size: 0.85rem;
    font-weight: 800;
    color: var(--accent);
  }

  .wp-bar-container {
    height: 8px;
    background: #2a2a4a;
    border-radius: 4px;
    overflow: hidden;
  }

  .wp-bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.4s ease, background 0.3s;
    background: linear-gradient(90deg, var(--accent), var(--pink));
  }

  .wp-bar-fill.complete {
    background: linear-gradient(90deg, var(--success), var(--blue));
  }

  .window-complete-msg {
    margin-top: 8px;
    text-align: center;
    font-weight: 700;
    font-size: 0.9rem;
    color: var(--success);
    display: none;
    animation: revealPop 0.5s ease;
  }

  .window-complete-msg.show { display: block; }
</style>
</head>
<body>

<!-- Room Selection -->
<div class="room-screen" id="roomScreen">
  <div class="room-box">
    <h1>üé§ N'oubliez pas les Paroles</h1>
    <p class="subtitle">Cr√©ez ou rejoignez une room pour commencer</p>

    <div class="room-input-group">
      <input type="text" class="room-input" id="roomInput"
             placeholder="Nom de room (ex: wilfried)"
             maxlength="20"
             onkeydown="if(event.key==='Enter') joinRoom()"
             oninput="this.value = this.value.toLowerCase().replace(/[^a-z0-9-]/g, '')">
      <button class="room-btn primary" onclick="joinRoom()">Rejoindre</button>
    </div>
    <div class="room-error" id="roomError"></div>

    <div class="room-or">‚Äî ou ‚Äî</div>

    <button class="room-btn secondary" onclick="createRandomRoom()">üé≤ Cr√©er une room al√©atoire</button>
  </div>
</div>

<!-- Party Mode Modal -->
<div class="modal-overlay hidden" id="partyModal">
  <div class="modal-box">
    <h2>üéÆ Nouvelle Partie</h2>

    <div class="modal-field">
      <label>Nombre de chansons</label>
      <input type="number" id="partyCount" value="5" min="1" max="99" oninput="updatePartyPreview()">
    </div>

    <div class="modal-field">
      <label>Filtrer par difficult√©</label>
      <div class="filter-chips" id="difficultyChips"></div>
      <div style="font-size:0.68rem;color:var(--text-dim);margin-top:6px;">
        Cliquer : <span style="color:var(--success)">‚úì inclure</span> ‚Üí
        <span style="color:var(--danger)">‚úï exclure</span> ‚Üí neutre
      </div>
    </div>

    <div class="modal-field">
      <label>Filtrer par artiste</label>
      <div class="filter-chips" id="artistChips"></div>
    </div>

    <div class="modal-field">
      <label>Filtrer par tags</label>
      <div class="filter-chips" id="tagChips"></div>
    </div>

    <div class="modal-match-count" id="partyMatchCount"></div>

    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closePartyModal()">Annuler</button>
      <button class="btn btn-primary" id="btnStartParty" onclick="startParty()">üéÆ Lancer la partie</button>
    </div>
  </div>
</div>

<!-- Party Results Modal -->
<div class="modal-overlay hidden" id="partyResultsModal">
  <div class="modal-box">
    <h2>üèÜ R√©sultats de la Partie</h2>
    <div class="party-results-list" id="partyResultsList"></div>
    <div class="party-total-score">
      <div class="label">SCORE TOTAL</div>
      <div class="big-score" id="partyFinalScore">0</div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closePartyResults()">Fermer</button>
      <button class="btn btn-primary" onclick="closePartyResults(); openPartyModal();">üéÆ Rejouer</button>
    </div>
  </div>
</div>

<!-- Loading -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div style="color: var(--text-dim); font-size: 0.9rem;">Chargement de la biblioth√®que...</div>
</div>

<div class="app">
  <!-- Top Bar -->
  <div class="top-bar-app">
    <div class="top-bar-left">
      <button class="topbar-btn accent" onclick="toggleDrawer()">üìö Biblioth√®que</button>
    </div>
    <div class="top-bar-center">
      <div class="header">
        <h1>üé§ N'oubliez pas les Paroles</h1>
      </div>
    </div>
    <div class="top-bar-right">
      <div class="room-badge" id="roomBadge" onclick="copyOverlayUrl()" title="Copier URL overlay" style="font-size:0.72rem;padding:5px 10px;">
        <span id="roomDisplay">‚Äî</span>
      </div>
      <span id="copyMsg" style="color:var(--success);font-size:0.65rem;opacity:0;transition:opacity 0.3s;">‚úì</span>
      <button class="topbar-btn" onclick="document.getElementById('subtitleSettingsModal').classList.remove('hidden')">üé®</button>
      <button class="topbar-btn" onclick="document.getElementById('obsModal').classList.remove('hidden')">üì°</button>
      <button class="topbar-btn" onclick="document.getElementById('guideModal').classList.remove('hidden')">üìñ</button>
    </div>
  </div>

  <!-- Party HUD -->
  <div class="party-hud" id="partyHud">
    <span class="party-info" id="partyInfo">üéÆ Chanson 1/5</span>
    <span class="party-score" id="partyTotalDisplay">Score: 0</span>
    <button class="btn-sm" onclick="endParty()">‚úï Arr√™ter</button>
  </div>

  <!-- Main Stage -->
  <div class="main-stage">
    <div class="stage-left">
      <div class="video-row">
        <!-- Video -->
        <div class="video-stage" id="videoStage">
          <video id="videoPlayer" playsinline crossorigin="anonymous"></video>

          <div class="countdown-overlay hidden" id="countdownOverlay">
            <div class="countdown-number" id="countdownNumber">5</div>
            <div class="countdown-label" id="countdownLabel">Prochaine chanson...</div>
          </div>

          <div class="placeholder" id="placeholder">
            <div class="icon">üé¨</div>
            <div class="msg">S√©lectionnez une chanson</div>
          </div>

          <div class="score-display" style="display:none" id="scoreBox">
            <div class="label">Score</div>
            <div class="value" id="scoreValue">0</div>
          </div>

          <div class="status-bar">
            <div class="status-pill paused" id="statusPill">‚è∏ En attente</div>
          </div>

          <div class="subtitle-overlay">
            <div class="subtitle-text" id="subtitleText"></div>
          </div>
        </div>

        <!-- Side Controls -->
        <div class="video-controls-side">
          <button class="btn btn-primary" id="btnPlay" onclick="togglePlay()" disabled>‚ñ∂ Jouer</button>
          <button class="btn btn-success" id="btnReveal" onclick="revealNext()" disabled>üëÅ R√©v√©ler</button>
          <button class="btn btn-secondary" onclick="resetGame()">‚Ü∫ Reset</button>
        </div>
      </div>

      <!-- Progress -->
      <div class="progress-container" id="progressContainer" style="margin-top:6px;">
        <div id="cutoffMarkers"></div>
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div class="time-display" style="font-size:0.72rem;">
        <span><span id="currentTime">0:00</span> / <span id="totalTime">0:00</span></span>
        <span id="cutoffInfo" style="color: var(--danger);"></span>
      </div>

      <!-- Volume -->
      <div class="volume-control" style="margin:4px 0;padding:6px 12px;">
        <span class="vol-icon" id="volIcon" onclick="toggleMuteManual()">üîä</span>
        <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="80" oninput="setVolume(this.value)">
        <span class="volume-pct" id="volumePct">80%</span>
        <label class="sound-mode-label" style="margin-left:12px;font-size:0.72rem;">
          <input type="checkbox" id="soundModeCheck" onchange="toggleSoundMode()" checked>
          üîä Reprise auto
        </label>
      </div>
    </div>

    <div class="stage-right">
      <!-- Guess Area -->
      <div class="guess-area visible" id="guessArea">
        <h3>üé§ Devinez les paroles</h3>
        <div class="guess-input-row">
          <input type="text" class="guess-input" id="guessInput"
                 placeholder="Tapez un ou plusieurs mots..."
                 onkeydown="if(event.key==='Enter') checkGuess()" autocomplete="off">
          <button class="btn btn-primary" onclick="checkGuess()">OK</button>
        </div>
        <div class="guess-feedback" id="guessFeedback"></div>
        <div style="margin-top:6px;font-size:0.72rem;color:var(--text-dim)">
          üí° Tapez plusieurs mots ou une phrase. Appuyez sur ‚ñ∂ pour continuer.
        </div>
      </div>

      <!-- Window Progress -->
      <div class="window-progress" id="windowProgress">
        <div class="window-progress-header">
          <span class="wp-label" id="wpLabel">Fen√™tre 1/1</span>
          <span class="wp-count" id="wpCount">0 / 0 mots</span>
        </div>
        <div class="wp-bar-container">
          <div class="wp-bar-fill" id="wpBarFill" style="width:0%"></div>
        </div>
        <div class="window-complete-msg" id="wpComplete">
          ‚úÖ Fen√™tre compl√®te !
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Library Drawer -->
<div class="drawer-backdrop" onclick="toggleDrawer()"></div>
<div class="library-drawer" id="libraryDrawer">
  <div class="drawer-header">
    <h3>üìö Biblioth√®que</h3>
    <div style="display:flex;align-items:center;gap:6px;">
      <button class="btn-sm party" onclick="openPartyModal()">üéÆ Partie</button>
      <button class="btn-sm random" onclick="pickRandom()">üé≤</button>
      <button class="btn-sm refresh" onclick="refreshLibrary()">‚Üª</button>
      <button class="drawer-close-btn" onclick="toggleDrawer()">‚úï</button>
    </div>
  </div>
  <div class="drawer-body">
    <div class="song-count" id="songCount"></div>
    <input type="text" class="search-box" id="searchBox" placeholder="üîç Rechercher..." oninput="filterSongs()">
    <div class="song-list" id="songList"></div>
    <div class="pagination" id="pagination"></div>
  </div>
  <div class="drawer-footer">
    <div style="display:flex;align-items:center;gap:6px;font-size:0.72rem;color:var(--text-dim);">
      Par page :
      <select id="pageSize" onchange="changePageSize()">
        <option value="10">10</option>
        <option value="20" selected>20</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
    </div>
  </div>
</div>

<!-- Subtitle Settings Modal -->
<div class="modal-overlay hidden" id="subtitleSettingsModal">
  <div class="modal-box">
    <h2>üé® Personnalisation des sous-titres</h2>

    <div class="setting-row">
      <label>Texte normal</label>
      <input type="color" id="subColorBase" value="#f0f0f0" oninput="updateSubSettings()">
    </div>
    <div class="setting-row">
      <label>Mot en surbrillance</label>
      <input type="color" id="subColorHighlight" value="#f7b731" oninput="updateSubSettings()">
    </div>
    <div class="setting-row">
      <label>Mot trouv√©</label>
      <input type="color" id="subColorRevealed" value="#00b894" oninput="updateSubSettings()">
    </div>
    <div class="setting-row">
      <label>Fond mot trouv√©</label>
      <input type="color" id="subBgRevealed" value="#00b894" oninput="updateSubSettings()">
      <input type="range" id="subBgRevealedAlpha" min="0" max="100" value="25" oninput="updateSubSettings()">
      <span class="range-value" id="subBgRevealedAlphaVal">25%</span>
    </div>
    <div class="setting-row">
      <label>Ch≈ìurs</label>
      <input type="color" id="subColorBacking" value="#8888aa" oninput="updateSubSettings()">
      <input type="range" id="subAlphaBacking" min="10" max="100" value="60" oninput="updateSubSettings()">
      <span class="range-value" id="subAlphaBackingVal">60%</span>
    </div>
    <div class="setting-row">
      <label>Fond sous-titres</label>
      <input type="color" id="subBgColor" value="#000000" oninput="updateSubSettings()">
      <input type="range" id="subBgAlpha" min="0" max="100" value="0" oninput="updateSubSettings()">
      <span class="range-value" id="subBgAlphaVal">0%</span>
    </div>
    <div class="setting-row">
      <label>Taille du texte</label>
      <input type="range" id="subFontSize" min="12" max="40" value="24" oninput="updateSubSettings()">
      <span class="range-value" id="subFontSizeVal">24px</span>
    </div>

    <div class="subtitle-preview" id="subtitlePreview">
      <div class="preview-text" id="previewText"></div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="resetSubSettings()">‚Ü∫ R√©initialiser</button>
      <button class="btn btn-primary" onclick="document.getElementById('subtitleSettingsModal').classList.add('hidden')">Fermer</button>
    </div>
  </div>
</div>

<!-- OBS Modal -->
<div class="modal-overlay hidden" id="obsModal">
  <div class="modal-box">
    <h2>üì° Configuration OBS</h2>
    <p style="margin-bottom:12px;">
      Ajoutez une <strong>Source Navigateur</strong> dans OBS avec l'URL overlay
      (cliquez sur le badge room pour copier).
    </p>
    <p>
      <kbd id="overlayUrl" style="cursor:pointer;display:inline-block;padding:6px 12px;font-size:0.85rem;" onclick="copyOverlayUrl()" title="Copier">
        chargement...
      </kbd>
    </p>
    <p style="margin-top:12px;">
      L'overlay est transparent. Taille recommand√©e : <kbd>1280√ó720</kbd>.
      URL permanente tant que vous gardez le m√™me nom de room.
    </p>
    <div class="modal-actions" style="margin-top:16px;">
      <button class="btn btn-secondary" onclick="document.getElementById('obsModal').classList.add('hidden')">Fermer</button>
    </div>
  </div>
</div>

<!-- Guide Modal -->
<div class="modal-overlay hidden" id="guideModal">
  <div class="modal-box">
    <h2>üìñ Guide rapide</h2>
    <p>
      Placez vos chansons dans <kbd>videos/</kbd>. Chaque sous-dossier = 1 chanson avec un <kbd>.srt</kbd>.
      Ajoutez <kbd>config.json</kbd> pour titre, artiste, difficult√©, tags et coupure.
    </p>
    <p style="margin-top:10px;">
      Whisper : <kbd>whisper video.mp4 --language fr --output_format srt</kbd>
    </p>
    <p style="margin-top:10px;">
      <strong>Calage :</strong> <kbd>"subtitle_offset": -0.3</kbd> (avance 300ms)
    </p>
    <p style="margin-top:10px;">
      <strong>Tags :</strong> <kbd>"tags": ["pop", "fran√ßais"]</kbd>
    </p>
    <p style="margin-top:10px;">
      <strong>Ch≈ìurs :</strong> Parenth√®ses dans le SRT ‚Üí affich√©s mais pas √† deviner.
    </p>
    <div class="modal-actions" style="margin-top:16px;">
      <button class="btn btn-secondary" onclick="document.getElementById('guideModal').classList.add('hidden')">Fermer</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// STATE
// ============================================================
const API = '';
let currentRoom = null;     // room ID
let songs = [];
let currentSong = null;
let isMuted = false;       // game mute (cutoff active)
let score = 0;
let revealedWords = new Set();
let hiddenWordIndices = [];
let subtitleInterval = null;
let currentWindowIdx = -1; // which cutoff window we're in (-1 = none)
let savedVolume = 0.8;     // remember volume before game mute
let lastSubtitleHtml = '';  // track last rendered HTML to avoid flickering
let lastLineIdx = -1;       // track current line to detect changes
let replayAfterComplete = true; // sound mode: replay sound after all words found

// Pagination
let currentPage = 1;
let pageSize = 20;
let filteredSongs = [];

function toggleDrawer() {
  document.body.classList.toggle('drawer-open');
}

// Party mode state
let partyMode = false;
let partyQueue = [];          // array of song objects for the party
let partyCurrentIdx = -1;     // which song in the queue
let partyTotalScore = 0;      // cumulative score across songs
let partyScores = [];         // per-song scores [{title, artist, score, total}]
let partyCountdown = null;    // countdown timer
let partyCountdownValue = 0;  // current countdown value (0 = inactive)

const video = document.getElementById('videoPlayer');
video.volume = 0.8;

// End of video ‚Üí show final score or next party song
video.addEventListener('ended', () => {
  pause();
  if (partyMode) {
    showFinalScore();
    onSongEndedInParty();
  } else {
    showFinalScore();
  }
});

// Update total time and re-render markers when video metadata loads
video.addEventListener('loadedmetadata', () => {
  if (video.duration && !isNaN(video.duration)) {
    document.getElementById('totalTime').textContent = formatTime(video.duration);
    if (currentSong) renderCutoffMarkers();
  }
});

// ============================================================
// API CALLS
// ============================================================
async function fetchSongs() {
  try {
    const res = await fetch(`${API}/api/songs`);
    const data = await res.json();
    return data.songs || [];
  } catch (e) {
    console.error('Erreur de connexion au serveur:', e);
    return [];
  }
}

async function fetchSongDetail(id) {
  const res = await fetch(`${API}/api/songs/${id}`);
  return res.json();
}

async function fetchRandomSong() {
  const res = await fetch(`${API}/api/random`);
  return res.json();
}

async function refreshLibrary() {
  showLoading(true);
  try {
    const res = await fetch(`${API}/api/refresh`);
    const data = await res.json();
    songs = data.songs || [];
    renderSongList(songs);
  } catch (e) {
    console.error('Erreur refresh:', e);
  }
  showLoading(false);
}

// ============================================================
// UI RENDERING
// ============================================================
function renderSongList(list) {
  filteredSongs = list;
  const container = document.getElementById('songList');
  document.getElementById('songCount').textContent = `${list.length} chanson${list.length > 1 ? 's' : ''} disponible${list.length > 1 ? 's' : ''}`;

  if (list.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="icon">üìÅ</div>
        <h3>Aucune chanson trouv√©e</h3>
        <p>Ajoutez des chansons ou changez vos filtres</p>
      </div>`;
    document.getElementById('pagination').innerHTML = '';
    return;
  }

  // Pagination
  const totalPages = Math.ceil(list.length / pageSize);
  if (currentPage > totalPages) currentPage = totalPages;
  const start = (currentPage - 1) * pageSize;
  const end = Math.min(start + pageSize, list.length);
  const page = list.slice(start, end);

  container.innerHTML = page.map(song => {
    const diffLabel = {easy:'Facile', medium:'Moyen', hard:'Difficile'}[song.difficulty] || 'Moyen';
    const isActive = currentSong && currentSong.id === song.id;
    const duration = formatTime(song.duration);
    const windows = song.cutoff_windows || [];
    const windowsStr = windows.map(w => `${formatTime(w[0])}‚Üí${formatTime(w[1])}`).join(', ');
    const tagsHtml = (song.tags || []).map(t => `<span class="tag-badge">${t}</span>`).join('');

    return `
      <div class="song-item ${isActive ? 'active' : ''}" onclick="selectSong('${song.id}')">
        <div class="song-info">
          <div class="title">${song.title}</div>
          <div class="artist">${song.artist}</div>
          <div class="meta">${duration} ‚Ä¢ ‚úÇ ${windowsStr}</div>
          ${tagsHtml ? `<div class="tags-row">${tagsHtml}</div>` : ''}
        </div>
        <div class="song-right">
          ${!song.has_video ? '<span class="no-video-badge">SRT seul</span>' : ''}
          <span class="difficulty ${song.difficulty}">${diffLabel}</span>
        </div>
      </div>`;
  }).join('');

  // Pagination controls
  const pagEl = document.getElementById('pagination');
  if (totalPages <= 1) {
    pagEl.innerHTML = '';
  } else {
    pagEl.innerHTML = `
      <button onclick="goPage(1)" ${currentPage === 1 ? 'disabled' : ''}>&laquo;</button>
      <button onclick="goPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&lsaquo;</button>
      <span class="page-info">${currentPage} / ${totalPages}</span>
      <button onclick="goPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>&rsaquo;</button>
      <button onclick="goPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>&raquo;</button>
    `;
  }
}

function goPage(n) {
  currentPage = n;
  renderSongList(filteredSongs);
}

function changePageSize() {
  pageSize = parseInt(document.getElementById('pageSize').value);
  currentPage = 1;
  renderSongList(filteredSongs);
}

function filterSongs() {
  currentPage = 1;
  const q = document.getElementById('searchBox').value.toLowerCase().trim();
  if (!q) {
    renderSongList(songs);
    return;
  }
  const filtered = songs.filter(s =>
    s.title.toLowerCase().includes(q) ||
    s.artist.toLowerCase().includes(q) ||
    (s.tags || []).some(tag => tag.toLowerCase().includes(q))
  );
  renderSongList(filtered);
}

function showLoading(show) {
  document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
}

// ============================================================
// SONG SELECTION
// ============================================================
async function selectSong(id) {
  resetGame();
  showLoading(true);

  try {
    currentSong = await fetchSongDetail(id);
  } catch (e) {
    console.error('Erreur chargement chanson:', e);
    showLoading(false);
    return;
  }

  // Setup video
  const placeholder = document.getElementById('placeholder');
  if (currentSong.video_url) {
    video.src = currentSong.video_url;
    video.load();
    placeholder.style.display = 'none';
  } else {
    video.removeAttribute('src');
    placeholder.style.display = 'flex';
    placeholder.querySelector('.msg').textContent = `üéµ ${currentSong.title} ‚Äî ${currentSong.artist} (audio seul)`;
  }

  // Update UI
  document.getElementById('totalTime').textContent = formatTime(currentSong.duration);
  renderCutoffMarkers();

  document.getElementById('btnPlay').disabled = false;
  document.getElementById('scoreBox').style.display = 'block';

  document.getElementById('subtitleText').innerHTML =
    `<span class="word" style="color: var(--accent);">‚ô™ ${currentSong.title} ‚Äî ${currentSong.artist} ‚ô™</span>`;

  // Update active state in list
  renderSongList(songs.length ? songs : [currentSong]);

  showLoading(false);
}

async function pickRandom() {
  if (songs.length === 0) return;
  resetGame();
  showLoading(true);

  try {
    const song = await fetchRandomSong();
    // We have the full detail already from /api/random
    currentSong = song;

    const placeholder = document.getElementById('placeholder');
    if (currentSong.video_url) {
      video.src = currentSong.video_url;
      video.load();
      placeholder.style.display = 'none';
    } else {
      video.removeAttribute('src');
      placeholder.style.display = 'flex';
      placeholder.querySelector('.msg').textContent = `üéµ ${currentSong.title} ‚Äî ${currentSong.artist}`;
    }

    document.getElementById('totalTime').textContent = formatTime(currentSong.duration);
    renderCutoffMarkers();

    document.getElementById('btnPlay').disabled = false;
    document.getElementById('scoreBox').style.display = 'block';
    document.getElementById('subtitleText').innerHTML =
      `<span class="word" style="color: var(--accent);">üé≤ ${currentSong.title} ‚Äî ${currentSong.artist} ‚ô™</span>`;

    renderSongList(songs);
  } catch (e) {
    console.error('Erreur random:', e);
  }
  showLoading(false);
}

// ============================================================
// PLAYBACK
// ============================================================
function togglePlay() {
  if (!currentSong) return;
  if (video.paused || !video.src) {
    play();
  } else {
    pause();
  }
}

function play() {
  if (currentSong.video_url && video.src) {
    video.play().catch(() => {});
  }
  document.getElementById('btnPlay').innerHTML = '‚è∏ Pause';
  updateStatus(isMuted ? 'muted' : 'playing');
  startSubtitleLoop();
  updateRevealButton();
}

function pause() {
  if (video.src) video.pause();
  document.getElementById('btnPlay').innerHTML = '‚ñ∂ Reprendre';
  updateStatus(isMuted ? 'muted' : 'paused');
  stopSubtitleLoop();
  updateRevealButton();
}

function startSubtitleLoop() {
  stopSubtitleLoop();
  subtitleInterval = setInterval(updateSubtitles, 80);
}

function stopSubtitleLoop() {
  if (subtitleInterval) clearInterval(subtitleInterval);
  subtitleInterval = null;
}

function getCurrentTime() {
  if (video.src && !isNaN(video.currentTime)) return video.currentTime;
  return 0;
}

function updateSubtitles() {
  if (!currentSong || !currentSong.lyrics) return;
  const t = getCurrentTime();

  // Use actual video duration if available, fallback to SRT duration
  const duration = getEffectiveDuration();
  const pct = Math.min((t / duration) * 100, 100);
  document.getElementById('progressBar').style.width = `${pct}%`;
  document.getElementById('currentTime').textContent = formatTime(t);

  // Auto cutoff/unmute based on windows
  const windows = currentSong.cutoff_windows || [];
  const inWindow = windows.findIndex(w => t >= w[0] && t < w[1]);

  if (inWindow !== -1 && !isMuted) {
    // Entering a cutoff window ‚Üí mute + auto pause
    currentWindowIdx = inWindow;
    triggerCutoff();
    return; // pause stops the loop
  } else if (inWindow === -1 && isMuted) {
    // Exiting a cutoff window ‚Üí restore sound
    restoreSound();
  }

  // Find current lyric line
  renderCurrentSubtitle(t);
}

function renderCurrentSubtitle(t, force) {
  // Apply subtitle offset from config
  const offset = (currentSong && currentSong.subtitle_offset) ? currentSong.subtitle_offset : 0;
  const adjustedT = t + offset;

  const lyrics = currentSong._processedLyrics || currentSong.lyrics;
  const currentLine = lyrics.find(l => adjustedT >= l.start && adjustedT < l.end);
  const subtitleEl = document.getElementById('subtitleText');

  if (currentLine) {
    const lineIdx = lyrics.indexOf(currentLine);
    const tokens = currentLine.tokens || currentLine.text.split(/\s+/).map((t, i) => ({ text: t, origWordIdx: i, isHyphen: false }));
    const wordProgress = (adjustedT - currentLine.start) / (currentLine.end - currentLine.start);
    const highlightIdx = Math.floor(wordProgress * tokens.length);

    // Determine which window this line belongs to (for display scoping)
    const windows = currentSong.cutoff_windows || [];
    const lineWinIdx = windows.findIndex(w => currentLine.end > w[0] && currentLine.start < w[1]);

    // Build new HTML
    let inParens = false;
    const html = tokens.map((token, ti) => {
      if (token.text.includes('(')) inParens = true;
      const isParenWord = inParens;
      if (token.text.includes(')')) inParens = false;

      const key = `${lineIdx}-${ti}`;
      const isRevealed = revealedWords.has(key);
      const isInHiddenList = hiddenWordIndices.some(h => h.lineIdx === lineIdx && h.tokenIdx === ti);
      const isPunctOnly = normalizeWord(token.text).length === 0;

      // Only hide if this word belongs to the current or a future window
      // Words already found in previous windows stay revealed
      const isHidden = isInHiddenList && !isRevealed && !isPunctOnly && !isParenWord;

      if (token.isHyphen) {
        // Always show hyphens
        return `<span class="word" style="margin:0 -2px;">-</span>`;
      } else if (isHidden) {
        const match = token.text.match(/^([^a-zA-Z√Ä-√ø0-9]*)(.*?)([^a-zA-Z√Ä-√ø0-9]*)$/);
        const prefix = match ? match[1] : '';
        const core = match ? match[2] : token.text;
        const suffix = match ? match[3] : '';
        return `${escapeHtml(prefix)}<span class="word hidden-word">${escapeHtml(core)}</span>${escapeHtml(suffix)}`;
      } else if (isRevealed) {
        return `<span class="word revealed-static">${escapeHtml(token.text)}</span>`;
      } else if (isParenWord) {
        return `<span class="word backing-vocal">${escapeHtml(token.text)}</span>`;
      } else {
        const cls = (!isMuted && ti === highlightIdx) ? 'highlighted' : '';
        return `<span class="word ${cls}">${escapeHtml(token.text)}</span>`;
      }
    }).join(' ');

    if (html !== lastSubtitleHtml || force) {
      subtitleEl.innerHTML = html;
      lastSubtitleHtml = html;
    }
    lastLineIdx = lineIdx;
  } else {
    let placeholder;
    if (!isMuted) {
      placeholder = '<span class="word" style="color:var(--text-dim)">‚ô™ ‚ô™ ‚ô™</span>';
    } else {
      placeholder = '<span class="word" style="color:var(--danger)">üîá √Ä vous de chanter !</span>';
    }
    if (placeholder !== lastSubtitleHtml) {
      subtitleEl.innerHTML = placeholder;
      lastSubtitleHtml = placeholder;
    }
    lastLineIdx = -1;
  }
}

// ============================================================
// GAME MECHANICS
// ============================================================
function triggerCutoff() {
  if (isMuted) return;
  isMuted = true;

  // Mute video
  savedVolume = video.volume;
  video.volume = 0;

  // Build hidden words for ALL windows (not just current)
  buildAllHiddenWords();

  // Auto-pause so the player has time to answer
  pause();

  updateStatus('muted');
  updateRevealButton();
  document.getElementById('guessArea').classList.add('active');
  document.getElementById('guessInput').focus();

  // Show window progress
  document.getElementById('windowProgress').classList.add('active');
  updateWindowProgress();

  // Show the hidden lyrics for the current position
  renderCurrentSubtitle(getCurrentTime());
}

function restoreSound() {
  if (!isMuted) return;
  isMuted = false;
  currentWindowIdx = -1;

  // Restore volume
  video.volume = savedVolume;

  updateRevealButton();
  updateStatus('playing');
}

function toggleSoundMode() {
  replayAfterComplete = document.getElementById('soundModeCheck').checked;
}

// ============================================================
// SUBTITLE CUSTOMIZATION
// ============================================================
const SUB_DEFAULTS = {
  colorBase: '#f0f0f0',
  colorHighlight: '#f7b731',
  colorRevealed: '#00b894',
  bgRevealed: '#00b894',
  bgRevealedAlpha: 25,
  colorBacking: '#8888aa',
  alphaBacking: 60,
  bgColor: '#000000',
  bgAlpha: 0,
  fontSize: 24,
};

let subSettings = { ...SUB_DEFAULTS };

function hexToRgba(hex, alpha) {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return `rgba(${r},${g},${b},${alpha})`;
}

function updateSubSettings() {
  subSettings.colorBase = document.getElementById('subColorBase').value;
  subSettings.colorHighlight = document.getElementById('subColorHighlight').value;
  subSettings.colorRevealed = document.getElementById('subColorRevealed').value;
  subSettings.bgRevealed = document.getElementById('subBgRevealed').value;
  subSettings.bgRevealedAlpha = parseInt(document.getElementById('subBgRevealedAlpha').value);
  subSettings.colorBacking = document.getElementById('subColorBacking').value;
  subSettings.alphaBacking = parseInt(document.getElementById('subAlphaBacking').value);
  subSettings.bgColor = document.getElementById('subBgColor').value;
  subSettings.bgAlpha = parseInt(document.getElementById('subBgAlpha').value);
  subSettings.fontSize = parseInt(document.getElementById('subFontSize').value);

  // Update display values
  document.getElementById('subAlphaBackingVal').textContent = `${subSettings.alphaBacking}%`;
  document.getElementById('subBgAlphaVal').textContent = `${subSettings.bgAlpha}%`;
  document.getElementById('subBgRevealedAlphaVal').textContent = `${subSettings.bgRevealedAlpha}%`;
  document.getElementById('subFontSizeVal').textContent = `${subSettings.fontSize}px`;

  applySubSettings();
  updateSubPreview();
  saveSubSettings();
}

function applySubSettings() {
  const root = document.documentElement.style;
  root.setProperty('--sub-color-base', subSettings.colorBase);
  root.setProperty('--sub-color-highlight', subSettings.colorHighlight);
  root.setProperty('--sub-color-revealed', subSettings.colorRevealed);
  root.setProperty('--sub-bg-revealed', hexToRgba(subSettings.bgRevealed, subSettings.bgRevealedAlpha / 100));
  root.setProperty('--sub-color-backing', subSettings.colorBacking);
  root.setProperty('--sub-alpha-backing', (subSettings.alphaBacking / 100).toFixed(2));
  root.setProperty('--sub-font-size', `${subSettings.fontSize}px`);

  const bgAlpha = subSettings.bgAlpha / 100;
  root.setProperty('--sub-bg', bgAlpha > 0 ? hexToRgba(subSettings.bgColor, bgAlpha) : 'transparent');
}

function updateSubPreview() {
  const preview = document.getElementById('previewText');
  const s = subSettings;
  const bg = s.bgAlpha > 0 ? hexToRgba(s.bgColor, s.bgAlpha / 100) : 'transparent';

  preview.style.fontSize = `${s.fontSize}px`;
  preview.style.background = bg;
  preview.style.padding = bg !== 'transparent' ? '4px 12px' : '0';
  preview.style.borderRadius = '8px';

  preview.innerHTML = [
    `<span class="word" style="color:${s.colorBase}">Je</span>`,
    `<span class="word" style="color:${s.colorHighlight}">chante</span>`,
    `<span class="word" style="color:${s.colorBase}">les</span>`,
    `<span class="word" style="background:rgba(255,255,255,0.13);color:transparent;border-radius:6px;min-width:50px;position:relative;">
      <span style="color:${s.colorBase};opacity:0.5;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:0.7em;letter-spacing:2px;">____</span>paroles</span>`,
    `<span class="word" style="color:${s.colorRevealed};background:${hexToRgba(s.bgRevealed, s.bgRevealedAlpha/100)};">trouv√©</span>`,
    `<span class="word" style="color:${s.colorBacking};opacity:${s.alphaBacking/100};font-style:italic;">(ch≈ìurs)</span>`,
  ].join(' ');
}

function resetSubSettings() {
  subSettings = { ...SUB_DEFAULTS };

  document.getElementById('subColorBase').value = subSettings.colorBase;
  document.getElementById('subColorHighlight').value = subSettings.colorHighlight;
  document.getElementById('subColorRevealed').value = subSettings.colorRevealed;
  document.getElementById('subBgRevealed').value = subSettings.bgRevealed;
  document.getElementById('subBgRevealedAlpha').value = subSettings.bgRevealedAlpha;
  document.getElementById('subColorBacking').value = subSettings.colorBacking;
  document.getElementById('subAlphaBacking').value = subSettings.alphaBacking;
  document.getElementById('subBgColor').value = subSettings.bgColor;
  document.getElementById('subBgAlpha').value = subSettings.bgAlpha;
  document.getElementById('subFontSize').value = subSettings.fontSize;

  updateSubSettings();
}

function saveSubSettings() {
  try { localStorage.setItem('karaoke_sub_settings', JSON.stringify(subSettings)); } catch(e) {}
}

function loadSubSettings() {
  try {
    const saved = localStorage.getItem('karaoke_sub_settings');
    if (saved) {
      subSettings = { ...SUB_DEFAULTS, ...JSON.parse(saved) };

      document.getElementById('subColorBase').value = subSettings.colorBase;
      document.getElementById('subColorHighlight').value = subSettings.colorHighlight;
      document.getElementById('subColorRevealed').value = subSettings.colorRevealed;
      document.getElementById('subBgRevealed').value = subSettings.bgRevealed;
      document.getElementById('subBgRevealedAlpha').value = subSettings.bgRevealedAlpha;
      document.getElementById('subColorBacking').value = subSettings.colorBacking;
      document.getElementById('subAlphaBacking').value = subSettings.alphaBacking;
      document.getElementById('subBgColor').value = subSettings.bgColor;
      document.getElementById('subBgAlpha').value = subSettings.bgAlpha;
      document.getElementById('subFontSize').value = subSettings.fontSize;

      updateSubSettings();
    } else {
      updateSubPreview();
    }
  } catch(e) {
    updateSubPreview();
  }
}

// (subtitle settings now in modal)

function updateRevealButton() {
  const btn = document.getElementById('btnReveal');
  // Only active when muted (in a cutoff window) AND video is paused AND window not complete
  if (!isMuted || !video.paused) {
    btn.disabled = true;
    return;
  }

  const winIdx = currentWindowIdx >= 0 ? currentWindowIdx : 0;
  const windowWords = hiddenWordIndices.filter(h => h.windowIdx === winIdx);
  const allFound = windowWords.length > 0 && windowWords.every(h => {
    const key = `${h.lineIdx}-${h.tokenIdx}`;
    return revealedWords.has(key);
  });

  btn.disabled = allFound;
}

// Called when all words in current window are found
function onWindowComplete() {
  updateRevealButton();

  if (replayAfterComplete) {
    // Restore sound and auto-play so the player can hear the passage
    video.volume = savedVolume;
    // Keep isMuted true so we re-mute when leaving the window
    play();
  }
}

function buildAllHiddenWords() {
  // Only rebuild if not already built (avoid wiping progress on re-entry)
  if (hiddenWordIndices.length > 0) return;

  hiddenWordIndices = [];
  const windows = currentSong.cutoff_windows || [];

  // Pre-process lyrics: split hyphenated words into sub-tokens
  // We store a mapping so we know which sub-tokens belong to which original word
  if (!currentSong._processedLyrics) {
    currentSong._processedLyrics = currentSong.lyrics.map(line => {
      const origWords = line.text.split(/\s+/);
      const tokens = []; // { text, origWordIdx, isHyphen }
      origWords.forEach((word, wi) => {
        // Split on hyphens: "peut-√™tre" ‚Üí ["peut", "-", "√™tre"]
        const parts = word.split(/(-)/);
        parts.forEach(part => {
          if (part.length > 0) {
            tokens.push({ text: part, origWordIdx: wi, isHyphen: part === '-' });
          }
        });
      });
      return { ...line, tokens };
    });
  }

  currentSong._processedLyrics.forEach((line, lineIdx) => {
    const winIdx = windows.findIndex(w => line.end > w[0] && line.start < w[1]);
    if (winIdx !== -1) {
      let inParentheses = false;

      line.tokens.forEach((token, tokenIdx) => {
        if (token.text.includes('(')) inParentheses = true;

        const cleaned = normalizeWord(token.text);
        if (cleaned.length > 0 && !inParentheses && !token.isHyphen) {
          hiddenWordIndices.push({
            lineIdx, tokenIdx, word: token.text, windowIdx: winIdx
          });
        }

        if (token.text.includes(')')) inParentheses = false;
      });
    }
  });

  console.log(`[buildAllHiddenWords] ${hiddenWordIndices.length} mots cach√©s sur ${windows.length} fen√™tre(s)`,
    windows.map((w, i) => `F${i+1}: ${hiddenWordIndices.filter(h => h.windowIdx === i).length} mots`).join(', ')
  );
}

function isTimeInCutoffWindow(t) {
  const windows = currentSong.cutoff_windows || [];
  return windows.some(w => t >= w[0] && t < w[1]);
}

// ============================================================
// MULTI-WORD FLEXIBLE MATCHING
// ============================================================
function checkGuess() {
  const input = document.getElementById('guessInput');
  const feedback = document.getElementById('guessFeedback');
  const rawGuess = input.value.trim();
  if (!rawGuess) return;

  // Split input into individual words
  const guessWords = rawGuess.split(/\s+/).map(w => normalizeWord(w)).filter(w => w.length > 0);
  if (guessWords.length === 0) return;

  const winIdx = currentWindowIdx >= 0 ? currentWindowIdx : 0;
  let totalFound = 0;
  let foundDisplayWords = [];

  // For each guess word, only match hidden words in the CURRENT window
  for (const guessWord of guessWords) {
    for (const item of hiddenWordIndices) {
      // Only match in current window
      if (item.windowIdx !== winIdx) continue;

      const key = `${item.lineIdx}-${item.tokenIdx}`;
      if (revealedWords.has(key)) continue;

      const hiddenClean = normalizeWord(item.word);
      if (hiddenClean.length === 0) continue;

      if (wordsMatch(guessWord, hiddenClean)) {
        // Reveal ALL instances of this word in the CURRENT window only
        const matchNorm = hiddenClean;
        for (const other of hiddenWordIndices) {
          if (other.windowIdx !== winIdx) continue;
          const otherKey = `${other.lineIdx}-${other.tokenIdx}`;
          if (revealedWords.has(otherKey)) continue;
          if (normalizeWord(other.word) === matchNorm) {
            revealedWords.add(otherKey);
            score += 10;
            totalFound++;
          }
        }
        foundDisplayWords.push(item.word);
        break; // Move to next guess word
      }
    }
  }

  if (totalFound > 0) {
    document.getElementById('scoreValue').textContent = partyMode ? (partyTotalScore + score) : score;
    input.value = '';
    input.style.borderColor = 'var(--success)';

    const wordsStr = foundDisplayWords.map(w => `"${w}"`).join(', ');
    const countInfo = totalFound > foundDisplayWords.length
      ? ` (+${totalFound - foundDisplayWords.length} identiques)`
      : '';
    feedback.innerHTML = `<span style="color:var(--success)">‚úì ${wordsStr} trouv√© !${countInfo}</span>`;

    setTimeout(() => { input.style.borderColor = '#333'; }, 600);

    // Refresh subtitle display (force to show animation)
    lastSubtitleHtml = ''; // force DOM update
    renderCurrentSubtitle(getCurrentTime(), true);
    checkWin();
  } else {
    input.style.borderColor = 'var(--danger)';
    feedback.innerHTML = `<span style="color:var(--danger)">‚úó Pas trouv√©... R√©essayez !</span>`;
    setTimeout(() => { input.style.borderColor = '#333'; }, 600);
  }
}

function normalizeWord(str) {
  // Remove punctuation, accents, lowercase
  return str
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')  // remove accents
    .replace(/[^a-z0-9]/g, '');       // remove punctuation
}

function wordsMatch(guess, target) {
  // Exact match
  if (guess === target) return true;

  // Flexible: allow 1 character difference for words > 3 chars (typo tolerance)
  if (guess.length > 3 && target.length > 3) {
    const dist = levenshtein(guess, target);
    if (dist <= 1) return true;
  }

  // Allow missing trailing 's' or 'e' (common French flex)
  if (guess + 's' === target || guess + 'e' === target) return true;
  if (target + 's' === guess || target + 'e' === guess) return true;

  return false;
}

function levenshtein(a, b) {
  const m = a.length, n = b.length;
  const dp = Array.from({length: m + 1}, () => Array(n + 1).fill(0));
  for (let i = 0; i <= m; i++) dp[i][0] = i;
  for (let j = 0; j <= n; j++) dp[0][j] = j;
  for (let i = 1; i <= m; i++) {
    for (let j = 1; j <= n; j++) {
      dp[i][j] = Math.min(
        dp[i-1][j] + 1,
        dp[i][j-1] + 1,
        dp[i-1][j-1] + (a[i-1] !== b[j-1] ? 1 : 0)
      );
    }
  }
  return dp[m][n];
}

function revealNext() {
  const winIdx = currentWindowIdx >= 0 ? currentWindowIdx : 0;

  // Try current window first
  for (const item of hiddenWordIndices) {
    if (item.windowIdx !== winIdx) continue;
    const key = `${item.lineIdx}-${item.tokenIdx}`;
    if (!revealedWords.has(key)) {
      revealedWords.add(key);
      lastSubtitleHtml = '';
      renderCurrentSubtitle(getCurrentTime(), true);
      checkWin();
      return;
    }
  }
  // Then any other window
  for (const item of hiddenWordIndices) {
    const key = `${item.lineIdx}-${item.tokenIdx}`;
    if (!revealedWords.has(key)) {
      revealedWords.add(key);
      lastSubtitleHtml = '';
      renderCurrentSubtitle(getCurrentTime(), true);
      checkWin();
      return;
    }
  }
}

function checkWin() {
  updateWindowProgress();

  // Count unrevealed words in current window only
  const winIdx = currentWindowIdx >= 0 ? currentWindowIdx : 0;
  let remaining = 0;
  for (const item of hiddenWordIndices) {
    if (item.windowIdx !== winIdx) continue;
    const key = `${item.lineIdx}-${item.tokenIdx}`;
    if (!revealedWords.has(key)) remaining++;
  }

  if (remaining === 0) {
    // Current window is complete
    onWindowComplete();

    // Check if ALL windows are complete
    let totalRemaining = 0;
    for (const item of hiddenWordIndices) {
      const key = `${item.lineIdx}-${item.tokenIdx}`;
      if (!revealedWords.has(key)) totalRemaining++;
    }
    if (totalRemaining === 0) {
      document.getElementById('guessFeedback').innerHTML =
        `<span style="color:var(--accent)">üèÜ Toutes les paroles trouv√©es ! Bravo !</span>`;
      document.getElementById('wpComplete').textContent = 'üèÜ Tout trouv√© ! Bravo !';
    }
  }

  updateRevealButton();
}

function updateWindowProgress() {
  const windows = currentSong.cutoff_windows || [];
  const totalWindows = windows.length;
  const winIdx = currentWindowIdx >= 0 ? currentWindowIdx : 0;

  // Count words for current window
  const windowWords = hiddenWordIndices.filter(h => h.windowIdx === winIdx);
  const totalInWindow = windowWords.length;
  const foundInWindow = windowWords.filter(h => {
    const key = `${h.lineIdx}-${h.tokenIdx}`;
    return revealedWords.has(key);
  }).length;

  // Count total remaining across all windows
  let totalRemaining = 0;
  for (const item of hiddenWordIndices) {
    const key = `${item.lineIdx}-${item.tokenIdx}`;
    if (!revealedWords.has(key)) totalRemaining++;
  }

  // Update labels
  const label = document.getElementById('wpLabel');
  label.textContent = totalWindows > 1
    ? `Fen√™tre ${winIdx + 1}/${totalWindows}`
    : `Passage √† deviner`;

  const count = document.getElementById('wpCount');
  count.textContent = `${foundInWindow} / ${totalInWindow} mots`;

  // Update bar
  const pct = totalInWindow > 0 ? (foundInWindow / totalInWindow) * 100 : 0;
  const bar = document.getElementById('wpBarFill');
  bar.style.width = `${pct}%`;

  const completeMsg = document.getElementById('wpComplete');
  const windowComplete = (foundInWindow === totalInWindow && totalInWindow > 0);

  if (windowComplete) {
    bar.classList.add('complete');
    completeMsg.classList.add('show');

    if (totalRemaining > 0) {
      completeMsg.textContent = `‚úÖ Fen√™tre compl√®te ! Appuyez sur ‚ñ∂ Reprendre pour continuer (${totalRemaining} mots restants)`;
    } else {
      completeMsg.textContent = `üèÜ Tout trouv√© ! Bravo !`;
    }
  } else {
    bar.classList.remove('complete');
    completeMsg.classList.remove('show');
  }
}

function showFinalScore() {
  const total = hiddenWordIndices.length * 10;
  const pct = total > 0 ? Math.round((score / total) * 100) : 0;
  const emoji = pct >= 80 ? 'üèÜ' : pct >= 50 ? 'üëè' : 'üòÖ';

  if (partyMode) {
    document.getElementById('subtitleText').innerHTML =
      `<span class="word" style="color: var(--accent);">${emoji} ${score}/${total} (${pct}%) ‚Äî Score total : ${partyTotalScore + score}</span>`;
  } else {
    document.getElementById('subtitleText').innerHTML =
      `<span class="word" style="color: var(--accent);">${emoji} Termin√© ! Score : ${score}/${total} (${pct}%)</span>`;
  }
}

function resetGame() {
  pause();
  isMuted = false;
  currentWindowIdx = -1;
  score = 0;
  revealedWords = new Set();
  hiddenWordIndices = [];
  lastSubtitleHtml = '';
  lastLineIdx = -1;
  if (currentSong) currentSong._processedLyrics = null;

  video.volume = savedVolume;
  video.currentTime = 0;

  document.getElementById('scoreValue').textContent = '0';
  document.getElementById('progressBar').style.width = '0%';
  document.getElementById('currentTime').textContent = '0:00';
  document.getElementById('btnPlay').innerHTML = '‚ñ∂ Jouer';
  document.getElementById('btnReveal').disabled = true;
  document.getElementById('guessArea').classList.remove('active');
  document.getElementById('guessFeedback').innerHTML = '';
  document.getElementById('windowProgress').classList.remove('active');
  document.getElementById('wpComplete').classList.remove('show');
  updateStatus('paused');

  if (currentSong) {
    document.getElementById('guessArea').classList.add('visible');
    renderCutoffMarkers();
    document.getElementById('subtitleText').innerHTML =
      `<span class="word" style="color: var(--accent);">‚ô™ ${currentSong.title} ‚Äî ${currentSong.artist} ‚ô™</span>`;
  }
}

// ============================================================
// HELPERS
// ============================================================
function updateStatus(type) {
  const pill = document.getElementById('statusPill');
  pill.className = 'status-pill ' + type;
  const labels = { playing: '‚ñ∂ En lecture', muted: 'üîá Son coup√©', paused: '‚è∏ En attente' };
  pill.innerHTML = labels[type] || '';
}

function formatTime(sec) {
  if (!sec || isNaN(sec)) return '0:00';
  const m = Math.floor(sec / 60);
  const s = Math.floor(sec % 60);
  return `${m}:${s.toString().padStart(2, '0')}`;
}

function normalize(str) {
  return str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
}

function escapeHtml(str) {
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// ============================================================
// VOLUME CONTROL
// ============================================================
function setVolume(val) {
  const vol = val / 100;
  video.volume = vol;
  savedVolume = vol;
  document.getElementById('volumePct').textContent = `${Math.round(val)}%`;
  updateVolIcon(vol);
}

function toggleMuteManual() {
  if (video.volume > 0) {
    savedVolume = video.volume;
    video.volume = 0;
    document.getElementById('volumeSlider').value = 0;
    document.getElementById('volumePct').textContent = '0%';
  } else {
    video.volume = savedVolume || 0.8;
    document.getElementById('volumeSlider').value = Math.round(video.volume * 100);
    document.getElementById('volumePct').textContent = `${Math.round(video.volume * 100)}%`;
  }
  updateVolIcon(video.volume);
}

function updateVolIcon(vol) {
  const icon = document.getElementById('volIcon');
  if (vol === 0) icon.textContent = 'üîá';
  else if (vol < 0.35) icon.textContent = 'üîà';
  else if (vol < 0.7) icon.textContent = 'üîâ';
  else icon.textContent = 'üîä';
}

// ============================================================
// CUTOFF WINDOW MARKERS
// ============================================================
function getEffectiveDuration() {
  return (video.duration && !isNaN(video.duration)) ? video.duration : (currentSong ? currentSong.duration : 1) || 1;
}

function renderCutoffMarkers() {
  const container = document.getElementById('cutoffMarkers');
  const infoEl = document.getElementById('cutoffInfo');
  const windows = currentSong.cutoff_windows || [];
  const duration = getEffectiveDuration();

  // Render markers on progress bar
  container.innerHTML = windows.map(w => {
    const leftPct = (w[0] / duration) * 100;
    const widthPct = ((w[1] - w[0]) / duration) * 100;
    return `<div class="cutoff-window-marker" style="left:${leftPct}%;width:${widthPct}%"></div>`;
  }).join('');

  // Info text
  const windowsStr = windows.map(w => `${formatTime(w[0])}‚Üí${formatTime(w[1])}`).join(' | ');
  infoEl.textContent = `‚úÇ ${windowsStr}`;
}

// Progress bar seeking
document.getElementById('progressContainer').addEventListener('click', (e) => {
  if (!currentSong) return;
  const rect = e.currentTarget.getBoundingClientRect();
  const pct = (e.clientX - rect.left) / rect.width;
  const duration = getEffectiveDuration();
  const newTime = pct * duration;
  if (video.src) video.currentTime = newTime;
});

// ============================================================
// PARTY MODE
// ============================================================
function openPartyModal() {
  // Build filter chips from available songs
  const artists = [...new Set(songs.map(s => s.artist))].sort();
  const allTags = [...new Set(songs.flatMap(s => s.tags || []))].sort();
  const difficulties = ['easy', 'medium', 'hard'];
  const diffLabels = {easy: 'üü¢ Facile', medium: 'üü° Moyen', hard: 'üî¥ Difficile'};

  document.getElementById('difficultyChips').innerHTML = difficulties
    .filter(d => songs.some(s => s.difficulty === d))
    .map(d => `<span class="filter-chip" data-value="${d}" onclick="toggleChip(this)">${diffLabels[d]}</span>`)
    .join('');

  document.getElementById('artistChips').innerHTML = artists
    .map(a => `<span class="filter-chip" data-value="${a}" onclick="toggleChip(this)">${a}</span>`)
    .join('');

  document.getElementById('tagChips').innerHTML = allTags
    .map(t => `<span class="filter-chip" data-value="${t}" onclick="toggleChip(this)">${t}</span>`)
    .join('');

  document.getElementById('partyCount').max = songs.length;
  updatePartyPreview();
  document.getElementById('partyModal').classList.remove('hidden');
}

function closePartyModal() {
  document.getElementById('partyModal').classList.add('hidden');
}

function toggleChip(el) {
  // Tri-state: neutral ‚Üí include ‚Üí exclude ‚Üí neutral
  if (el.classList.contains('exclude')) {
    el.classList.remove('exclude');
    // back to neutral
  } else if (el.classList.contains('include')) {
    el.classList.remove('include');
    el.classList.add('exclude');
  } else {
    el.classList.add('include');
  }
  updatePartyPreview();
}

function getChipValues(containerId) {
  const include = [...document.querySelectorAll(`#${containerId} .filter-chip.include`)]
    .map(el => el.dataset.value);
  const exclude = [...document.querySelectorAll(`#${containerId} .filter-chip.exclude`)]
    .map(el => el.dataset.value);
  return { include, exclude };
}

function getFilteredSongs() {
  const diff = getChipValues('difficultyChips');
  const artists = getChipValues('artistChips');
  const tags = getChipValues('tagChips');

  return songs.filter(s => {
    // Difficulty
    if (diff.exclude.includes(s.difficulty)) return false;
    if (diff.include.length > 0 && !diff.include.includes(s.difficulty)) return false;

    // Artists
    if (artists.exclude.includes(s.artist)) return false;
    if (artists.include.length > 0 && !artists.include.includes(s.artist)) return false;

    // Tags
    const songTags = s.tags || [];
    if (tags.exclude.some(t => songTags.includes(t))) return false;
    if (tags.include.length > 0 && !tags.include.some(t => songTags.includes(t))) return false;

    return true;
  });
}

function updatePartyPreview() {
  const matched = getFilteredSongs();
  let count = parseInt(document.getElementById('partyCount').value) || 1;
  const maxAvail = matched.length;

  if (count > maxAvail) {
    document.getElementById('partyCount').value = maxAvail;
    count = maxAvail;
  }

  const el = document.getElementById('partyMatchCount');
  el.innerHTML = `<strong>${maxAvail}</strong> chanson${maxAvail > 1 ? 's' : ''} correspondent aux filtres`;

  document.getElementById('btnStartParty').disabled = maxAvail === 0;
}

function shuffleArray(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

async function startParty() {
  const matched = getFilteredSongs();
  let count = parseInt(document.getElementById('partyCount').value) || 1;
  count = Math.min(count, matched.length);

  if (count === 0) return;

  // Shuffle and pick
  partyQueue = shuffleArray(matched).slice(0, count);
  partyCurrentIdx = -1;
  partyTotalScore = 0;
  partyScores = [];
  partyMode = true;

  closePartyModal();

  // Show party HUD
  document.getElementById('partyHud').classList.add('active');

  // Start first song
  await partyNextSong();
}

async function partyNextSong() {
  partyCurrentIdx++;

  if (partyCurrentIdx >= partyQueue.length) {
    // Party is over
    showPartyResults();
    return;
  }

  const songStub = partyQueue[partyCurrentIdx];

  // Update HUD
  document.getElementById('partyInfo').textContent =
    `üéÆ Chanson ${partyCurrentIdx + 1}/${partyQueue.length}`;
  document.getElementById('partyTotalDisplay').textContent =
    `Score: ${partyTotalScore}`;

  // Load song (need full detail with lyrics)
  resetGameForParty();
  showLoading(true);

  try {
    currentSong = await fetchSongDetail(songStub.id);
  } catch (e) {
    console.error('Erreur chargement:', e);
    showLoading(false);
    await partyNextSong(); // skip
    return;
  }

  const placeholder = document.getElementById('placeholder');
  if (currentSong.video_url) {
    video.src = currentSong.video_url;
    video.load();
    placeholder.style.display = 'none';
  } else {
    video.removeAttribute('src');
    placeholder.style.display = 'flex';
    placeholder.querySelector('.msg').textContent = `üéµ ${currentSong.title} ‚Äî ${currentSong.artist}`;
  }

  document.getElementById('totalTime').textContent = formatTime(currentSong.duration);
  renderCutoffMarkers();

  document.getElementById('btnPlay').disabled = false;
  document.getElementById('scoreBox').style.display = 'block';
  document.getElementById('scoreValue').textContent = partyTotalScore;
  document.getElementById('subtitleText').innerHTML =
    `<span class="word" style="color: var(--accent);">üéÆ ${partyCurrentIdx + 1}/${partyQueue.length} ‚Äî ${currentSong.title} ‚ô™</span>`;

  renderSongList(songs.length ? songs : [currentSong]);
  showLoading(false);

  // Auto-play
  togglePlay();
}

function resetGameForParty() {
  // Reset game state but keep party score
  pause();
  isMuted = false;
  currentWindowIdx = -1;
  score = 0; // per-song score
  revealedWords = new Set();
  hiddenWordIndices = [];
  lastSubtitleHtml = '';
  lastLineIdx = -1;
  if (currentSong) currentSong._processedLyrics = null;

  video.volume = savedVolume;
  video.currentTime = 0;

  document.getElementById('progressBar').style.width = '0%';
  document.getElementById('currentTime').textContent = '0:00';
  document.getElementById('btnPlay').innerHTML = '‚ñ∂ Jouer';
  document.getElementById('btnReveal').disabled = true;
  document.getElementById('guessArea').classList.remove('active');
  document.getElementById('guessFeedback').innerHTML = '';
  document.getElementById('windowProgress').classList.remove('active');
  document.getElementById('wpComplete').classList.remove('show');
  document.getElementById('countdownOverlay').classList.add('hidden');
  updateStatus('paused');
}

function onSongEndedInParty() {
  // Save per-song score
  const songTotal = hiddenWordIndices.length * 10;
  partyScores.push({
    title: currentSong.title,
    artist: currentSong.artist,
    score: score,
    total: songTotal,
  });
  partyTotalScore += score;

  // Update HUD
  document.getElementById('partyTotalDisplay').textContent =
    `Score: ${partyTotalScore}`;

  // Is there a next song?
  if (partyCurrentIdx + 1 >= partyQueue.length) {
    // Last song ‚Üí show results
    showPartyResults();
    return;
  }

  // Show countdown
  const overlay = document.getElementById('countdownOverlay');
  const numEl = document.getElementById('countdownNumber');
  const labelEl = document.getElementById('countdownLabel');
  overlay.classList.remove('hidden');
  let count = 5;
  partyCountdownValue = count;
  numEl.textContent = count;

  const nextSong = partyQueue[partyCurrentIdx + 1];
  labelEl.textContent = `Prochaine : ${nextSong.title || 'chanson suivante'}...`;

  if (partyCountdown) clearInterval(partyCountdown);
  partyCountdown = setInterval(() => {
    count--;
    partyCountdownValue = count;
    if (count <= 0) {
      clearInterval(partyCountdown);
      partyCountdown = null;
      partyCountdownValue = 0;
      overlay.classList.add('hidden');
      partyNextSong();
    } else {
      numEl.textContent = count;
    }
  }, 1000);
}

function showPartyResults() {
  partyMode = false;
  document.getElementById('partyHud').classList.remove('active');

  const list = document.getElementById('partyResultsList');
  list.innerHTML = partyScores.map((r, i) => {
    const pct = r.total > 0 ? Math.round((r.score / r.total) * 100) : 0;
    const emoji = pct >= 80 ? 'üèÜ' : pct >= 50 ? 'üëè' : 'üòÖ';
    return `
      <div class="party-result-row">
        <div>
          <div class="song-name">${emoji} ${r.title}</div>
          <div class="song-artist-sm">${r.artist} ‚Äî ${r.score}/${r.total} pts (${pct}%)</div>
        </div>
        <div class="result-score">${r.score}</div>
      </div>`;
  }).join('');

  document.getElementById('partyFinalScore').textContent = partyTotalScore;
  document.getElementById('partyResultsModal').classList.remove('hidden');
}

function closePartyResults() {
  document.getElementById('partyResultsModal').classList.add('hidden');
}

function endParty() {
  if (partyCountdown) { clearInterval(partyCountdown); partyCountdown = null; }
  document.getElementById('countdownOverlay').classList.add('hidden');

  // Save current song score
  if (currentSong && partyMode) {
    const songTotal = hiddenWordIndices.length * 10;
    partyScores.push({
      title: currentSong.title,
      artist: currentSong.artist,
      score: score,
      total: songTotal,
    });
    partyTotalScore += score;
  }

  showPartyResults();
}

// ============================================================
// STATE SYNC ‚Üí push state to server for overlay
// ============================================================
function pushState() {
  if (!currentSong || !currentRoom) return;
  const stateData = {
    song_id: currentSong.id,
    song_title: currentSong.title,
    song_artist: currentSong.artist,
    is_playing: !video.paused,
    is_muted: isMuted,
    current_time: getCurrentTime(),
    score: partyMode ? (partyTotalScore + score) : score,
    revealed_words: Array.from(revealedWords),
    window_idx: currentWindowIdx,
    cutoff_windows: currentSong.cutoff_windows || [],
    lyrics: currentSong.lyrics || [],
    video_url: currentSong.video_url || null,
    duration: currentSong.duration || 0,
    subtitle_offset: currentSong.subtitle_offset || 0,
    // Party mode info
    party_mode: partyMode,
    party_current: partyMode ? (partyCurrentIdx + 1) : 0,
    party_total: partyMode ? partyQueue.length : 0,
    party_countdown: partyCountdownValue,  // 0 = no countdown
    // Subtitle customization
    sub_settings: subSettings,
  };

  fetch(`${API}/api/state?room=${encodeURIComponent(currentRoom)}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(stateData),
  }).catch(() => {});
}

// Push state every 200ms
setInterval(pushState, 200);

// ============================================================
// ROOM MANAGEMENT
// ============================================================
function generateRoomCode() {
  const chars = 'abcdefghjkmnpqrstuvwxyz23456789';
  let code = 'room-';
  for (let i = 0; i < 4; i++) code += chars[Math.floor(Math.random() * chars.length)];
  return code;
}

function joinRoom() {
  const input = document.getElementById('roomInput');
  const error = document.getElementById('roomError');
  const name = input.value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '');

  if (!name || name.length < 2) {
    error.textContent = 'Le nom doit faire au moins 2 caract√®res (lettres, chiffres, tirets)';
    return;
  }

  enterRoom(name);
}

function createRandomRoom() {
  enterRoom(generateRoomCode());
}

function enterRoom(roomId) {
  currentRoom = roomId;

  // Save to localStorage for persistence
  try { localStorage.setItem('karaoke_room', roomId); } catch(e) {}

  // Update UI
  document.getElementById('roomScreen').classList.add('hidden');
  document.getElementById('roomDisplay').textContent = roomId;

  const overlayUrl = `${window.location.origin}/overlay?room=${encodeURIComponent(roomId)}`;
  document.getElementById('overlayUrl').textContent = overlayUrl;

  // Load library
  init();
}

function copyOverlayUrl() {
  if (!currentRoom) return;
  const url = `${window.location.origin}/overlay?room=${encodeURIComponent(currentRoom)}`;
  navigator.clipboard.writeText(url).then(() => {
    const msg = document.getElementById('copyMsg');
    msg.style.opacity = '1';
    setTimeout(() => { msg.style.opacity = '0'; }, 2000);
  }).catch(() => {});
}

// ============================================================
// INIT
// ============================================================
async function init() {
  showLoading(true);
  songs = await fetchSongs();
  renderSongList(songs);
  showLoading(false);

  // Display overlay URL
  if (currentRoom) {
    const overlayUrl = `${window.location.origin}/overlay?room=${encodeURIComponent(currentRoom)}`;
    document.getElementById('overlayUrl').textContent = overlayUrl;
  }
}

// Check for saved room or URL param
(function startup() {
  // Check URL param first (e.g. /?room=wilfried)
  const urlParams = new URLSearchParams(window.location.search);
  const urlRoom = urlParams.get('room');

  // Then check localStorage
  let savedRoom = null;
  try { savedRoom = localStorage.getItem('karaoke_room'); } catch(e) {}

  // Load subtitle settings
  loadSubSettings();

  if (urlRoom) {
    enterRoom(urlRoom);
  } else if (savedRoom) {
    // Pre-fill and auto-join saved room
    enterRoom(savedRoom);
  }
  // Otherwise the room screen stays visible
})();
</script>
</body>
</html>
